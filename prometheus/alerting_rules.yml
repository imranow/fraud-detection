groups:
  - name: fraud_detection_alerts
    rules:
      # High error rate alert
      - alert: HighErrorRate
        expr: |
          sum(rate(http_server_errors_total{job="fraud-detection"}[5m])) 
          / sum(rate(http_server_requests_total{job="fraud-detection"}[5m])) > 0.05
        for: 5m
        labels:
          severity: critical
          service: fraud-detection
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }} (> 5%) for the last 5 minutes."
          runbook_url: "https://wiki.example.com/runbooks/fraud-detection/high-error-rate"

      # High latency alert (P99 > 500ms)
      - alert: HighLatencyP99
        expr: |
          histogram_quantile(0.99, 
            sum(rate(fraud_prediction_latency_seconds_bucket{job="fraud-detection"}[5m])) by (le)
          ) > 0.5
        for: 5m
        labels:
          severity: warning
          service: fraud-detection
        annotations:
          summary: "High prediction latency detected"
          description: "P99 latency is {{ $value | humanizeDuration }} (> 500ms) for the last 5 minutes."

      # Very high latency (P99 > 2s)
      - alert: CriticalLatency
        expr: |
          histogram_quantile(0.99, 
            sum(rate(fraud_prediction_latency_seconds_bucket{job="fraud-detection"}[5m])) by (le)
          ) > 2
        for: 2m
        labels:
          severity: critical
          service: fraud-detection
        annotations:
          summary: "Critical prediction latency"
          description: "P99 latency is {{ $value | humanizeDuration }} (> 2s). Immediate action required."

      # Model not loaded
      - alert: ModelNotLoaded
        expr: up{job="fraud-detection"} == 1 and absent(fraud_predictions_total)
        for: 5m
        labels:
          severity: critical
          service: fraud-detection
        annotations:
          summary: "Model not loaded"
          description: "The fraud detection model is not loaded. No predictions are being made."

      # API down
      - alert: APIDown
        expr: up{job="fraud-detection"} == 0
        for: 1m
        labels:
          severity: critical
          service: fraud-detection
        annotations:
          summary: "Fraud Detection API is down"
          description: "The API has been unreachable for more than 1 minute."

      # Fraud spike detection (3x normal rate)
      - alert: FraudSpike
        expr: |
          sum(rate(fraud_detected_total{job="fraud-detection"}[5m])) 
          > 3 * avg_over_time(sum(rate(fraud_detected_total{job="fraud-detection"}[5m]))[1h:5m])
        for: 10m
        labels:
          severity: warning
          service: fraud-detection
        annotations:
          summary: "Unusual fraud spike detected"
          description: "Fraud detection rate is 3x higher than the hourly average. Current rate: {{ $value | humanize }}/sec"

      # Low prediction volume (might indicate traffic issue)
      - alert: LowPredictionVolume
        expr: |
          sum(rate(fraud_predictions_total{job="fraud-detection"}[5m])) < 0.1
          and sum(rate(fraud_predictions_total{job="fraud-detection"}[1h])) > 1
        for: 15m
        labels:
          severity: warning
          service: fraud-detection
        annotations:
          summary: "Low prediction volume"
          description: "Prediction rate has dropped significantly. Current: {{ $value | humanize }}/sec"

      # Memory usage high
      - alert: HighMemoryUsage
        expr: |
          process_resident_memory_bytes{job="fraud-detection"} 
          / on() container_spec_memory_limit_bytes{container="fraud-detection"} > 0.9
        for: 5m
        labels:
          severity: warning
          service: fraud-detection
        annotations:
          summary: "High memory usage"
          description: "Memory usage is above 90%. Consider scaling or investigating memory leaks."

      # Container restarts
      - alert: ContainerRestarts
        expr: |
          increase(kube_pod_container_status_restarts_total{container="fraud-detection"}[1h]) > 3
        for: 5m
        labels:
          severity: warning
          service: fraud-detection
        annotations:
          summary: "Container restarting frequently"
          description: "Container has restarted {{ $value }} times in the last hour."

      # Prediction accuracy drop (requires external ground truth)
      - alert: PredictionDrift
        expr: |
          abs(
            avg_over_time(fraud_prediction_probability_avg[1h])
            - avg_over_time(fraud_prediction_probability_avg[24h])
          ) > 0.1
        for: 30m
        labels:
          severity: info
          service: fraud-detection
        annotations:
          summary: "Prediction distribution drift detected"
          description: "Average prediction probability has shifted significantly in the last hour."
